#!/bin/bash

# sshrun - SSH管道管理器CLI命令
# 用法: sshrun [OPTIONS] COMMAND

set -euo pipefail

# 配置
if [[ -L "${BASH_SOURCE[0]}" ]]; then
    # 如果是符号链接，获取真实路径
    SCRIPT_DIR="$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"
else
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
fi
INSTALL_DIR="$HOME/.local/bin"
CONFIG_DIR="$HOME/.config/sshrun"

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[INFO]${NC} $*"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $*" >&2
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $*"
}

# 显示帮助信息
show_help() {
    cat << EOF
sshrun - SSH管道管理器CLI命令

基本用法:
    sshrun "command"                 # 执行远程命令
    sshrun start host [session_id]   # 启动SSH会话
    sshrun stop [session_id]         # 停止SSH会话
    sshrun restart host [session_id] # 重启SSH会话
    sshrun status [session_id]       # 查看会话状态
    sshrun list                      # 列出所有活动会话

配置管理:
    sshrun install                   # 安装到系统PATH
    sshrun uninstall                 # 从系统移除
    sshrun config                    # 显示配置信息

选项:
    -s, --session N    指定会话ID (默认: 0)
    -h, --help         显示帮助信息
    -v, --version      显示版本信息

示例:
    sshrun "whoami"                          # 执行whoami命令
    sshrun "ls -la | head -5"               # 执行带管道的命令
    sshrun start mini                       # 启动连接到mini的会话
    sshrun "hostname" --session 1           # 在会话1执行命令
    sshrun restart prod 2                   # 重启会话2连接到prod
    sshrun status                           # 查看默认会话状态

EOF
}

# 显示版本信息
show_version() {
    echo "sshrun v1.0.0 - SSH管道管理器"
    echo "GitHub: https://github.com/biantaishabi2/SSH-pipe-manager"
}

# 检查依赖
check_dependencies() {
    if [[ ! -f "$SCRIPT_DIR/ssh-start.sh" ]] ||
       [[ ! -f "$SCRIPT_DIR/ssh-stop.sh" ]] ||
       [[ ! -f "$SCRIPT_DIR/ssh-status.sh" ]] ||
       [[ ! -f "$SCRIPT_DIR/ai-run.sh" ]]; then
        log_error "SSH管道管理器脚本未找到，请确保在正确的目录中运行"
        exit 1
    fi
}

# 解析参数
parse_args() {
    SESSION_ID=0
    ACTION="run"
    COMMAND=""
    HOST=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            -v|--version)
                show_version
                exit 0
                ;;
            -s|--session)
                SESSION_ID="$2"
                shift 2
                ;;
            start|stop|restart|status|list|install|uninstall|config)
                ACTION="$1"
                if [[ "$1" == "start" || "$1" == "restart" ]]; then
                    if [[ $# -lt 2 ]]; then
                        log_error "缺少主机名参数"
                        echo "用法: sshrun $1 <hostname> [session_id]"
                        exit 1
                    fi
                    HOST="$2"
                    shift
                    if [[ $# -gt 1 && "$2" =~ ^[0-9]+$ ]]; then
                        SESSION_ID="$2"
                        shift
                    fi
                fi
                shift
                ;;
            *)
                if [[ "$ACTION" == "run" ]]; then
                    COMMAND="$1"
                fi
                shift
                ;;
        esac
    done
}

# 执行远程命令
run_command() {
    if [[ -z "$COMMAND" ]]; then
        log_error "缺少命令参数"
        echo "用法: sshrun \"command\""
        exit 1
    fi

    # 检查SSH小管家是否运行
    if ! "$SCRIPT_DIR/ssh-status.sh" "$SESSION_ID" >/dev/null 2>&1; then
        log_error "SSH会话 $SESSION_ID 未运行"
        echo "请先启动: sshrun start <hostname> $SESSION_ID"
        exit 1
    fi

    # 执行命令
    export SSH_SESSION="$SESSION_ID"
    "$SCRIPT_DIR/ai-run.sh" "$COMMAND"
}

# 启动SSH会话
start_session() {
    if [[ -z "$HOST" ]]; then
        log_error "缺少主机名参数"
        echo "用法: sshrun start <hostname> [session_id]"
        exit 1
    fi

    log_info "启动SSH会话: session_id=$SESSION_ID, host=$HOST"
    "$SCRIPT_DIR/ssh-start.sh" "$HOST" "$SESSION_ID"
}

# 停止SSH会话
stop_session() {
    log_info "停止SSH会话: session_id=$SESSION_ID"
    "$SCRIPT_DIR/ssh-stop.sh" "$SESSION_ID"
}

# 重启SSH会话
restart_session() {
    if [[ -z "$HOST" ]]; then
        log_error "缺少主机名参数"
        echo "用法: sshrun restart <hostname> [session_id]"
        exit 1
    fi

    log_info "重启SSH会话: session_id=$SESSION_ID, host=$HOST"
    "$SCRIPT_DIR/ssh-stop.sh" "$SESSION_ID" 2>/dev/null || true
    sleep 1
    "$SCRIPT_DIR/ssh-start.sh" "$HOST" "$SESSION_ID"
}

# 查看会话状态
show_status() {
    if "$SCRIPT_DIR/ssh-status.sh" "$SESSION_ID" 2>/dev/null; then
        log_info "SSH会话 $SESSION_ID 运行正常"
    else
        log_warn "SSH会话 $SESSION_ID 未运行或异常"
        exit 1
    fi
}

# 列出所有活动会话
list_sessions() {
    echo "活动SSH会话:"
    for session_file in /tmp/ssh-*.pid; do
        if [[ -f "$session_file" ]]; then
            session_id=$(basename "$session_file" .pid | sed 's/ssh-//')
            if "$SCRIPT_DIR/ssh-status.sh" "$session_id" >/dev/null 2>&1; then
                echo "  ✅ 会话 $session_id: 运行中"
            else
                echo "  ❌ 会话 $session_id: 已停止"
            fi
        fi
    done
}

# 安装到系统PATH
install_command() {
    log_info "安装sshrun到系统PATH..."

    # 创建安装目录
    mkdir -p "$INSTALL_DIR"

    # 创建符号链接
    ln -sf "$SCRIPT_DIR/sshrun" "$INSTALL_DIR/sshrun"

    # 检查PATH
    if [[ ":$PATH:" != *":$INSTALL_DIR:"* ]]; then
        echo ""
        log_warn "安装目录不在PATH中，请添加以下行到你的shell配置文件:"
        echo "export PATH=\"\$PATH:$INSTALL_DIR\""
        echo ""
        echo "然后运行: source ~/.bashrc  # 或 ~/.zshrc"
    else
        log_info "sshrun已安装，可以直接使用 'sshrun' 命令"
    fi
}

# 从系统移除
uninstall_command() {
    log_info "从系统移除sshrun..."
    if [[ -L "$INSTALL_DIR/sshrun" ]]; then
        rm "$INSTALL_DIR/sshrun"
        log_info "sshrun已从系统中移除"
    else
        log_warn "sshrun未安装在系统中"
    fi
}

# 显示配置信息
show_config() {
    echo "sshrun配置信息:"
    echo "  脚本目录: $SCRIPT_DIR"
    echo "  安装目录: $INSTALL_DIR"
    echo "  配置目录: $CONFIG_DIR"
    echo "  当前PATH: $PATH"

    if [[ -L "$INSTALL_DIR/sshrun" ]]; then
        echo "  安装状态: 已安装"
    else
        echo "  安装状态: 未安装"
    fi

    echo ""
    list_sessions
}

# 主函数
main() {
    check_dependencies
    parse_args "$@"

    case "$ACTION" in
        run)
            run_command
            ;;
        start)
            start_session
            ;;
        stop)
            stop_session
            ;;
        restart)
            restart_session
            ;;
        status)
            show_status
            ;;
        list)
            list_sessions
            ;;
        install)
            install_command
            ;;
        uninstall)
            uninstall_command
            ;;
        config)
            show_config
            ;;
        *)
            log_error "未知操作: $ACTION"
            show_help
            exit 1
            ;;
    esac
}

# 如果直接执行脚本
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi